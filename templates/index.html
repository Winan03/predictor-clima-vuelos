<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predictor de Retrasos de Vuelos</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    <link rel="stylesheet" href="/static/css/explicacion.css">
    <link rel="stylesheet" href="/static/css/index.css">
</head>
<body>
    <div class="container">
        <!-- Secci√≥n de autenticaci√≥n -->
        <div class="auth-section" id="auth-section">
            <div class="auth-container">
                <h2 id="auth-title">üîê Iniciar Sesi√≥n</h2>
                <p id="auth-subtitle">Inicie sesi√≥n para acceder al predictor de vuelos</p>
                <div id="auth-forms">
                    <div class="auth-form" id="login-form">
                        <div class="form-group">
                            <label for="login-email">Correo electr√≥nico</label>
                            <input type="email" id="login-email" placeholder="Correo electr√≥nico" required>
                          </div>
                          <div class="form-group">
                            <label for="login-password">Contrase√±a</label>
                            <div class="password-container">
                              <input type="password" id="login-password" placeholder="Contrase√±a" required>
                              <span class="toggle-password" onclick="togglePassword('login-password', this)">üëÅÔ∏è</span>
                            </div>
                        </div>                       
                        <button type="button" onclick="loginUser()">Iniciar Sesi√≥n</button>
                        <p><a href="#" onclick="showRegisterForm()">¬øNo tienes cuenta? Reg√≠strate</a></p>
                    </div>
                    <div class="auth-form hidden" id="register-form">
                        <div class="form-group">
                            <label for="register-name">Nombre completo</label>
                            <input type="text" id="register-name" placeholder="Tu nombre completo" required>
                          </div>
                          
                          <div class="form-group">
                            <label for="register-username">Nombre de usuario</label>
                            <input type="text" id="register-username" placeholder="Nombre de usuario" required>
                          </div>
                          
                          <div class="form-group">
                            <label for="register-email">Correo electr√≥nico</label>
                            <input type="email" id="register-email" placeholder="Correo electr√≥nico" required>
                          </div>
                          
                          <div class="form-group photo-upload">
                            <div class="photo-label-wrapper">
                              <label for="register-photo" class="photo-text">Foto de perfil (opcional)</label>
                              <input type="file" id="register-photo" accept="image/*" hidden>
                              <label for="register-photo" class="photo-circle">
                                <img id="preview-photo" src="/static/default-profile.png" alt="Foto de perfil" />
                                <div class="camera-icon">üì∑</div>
                              </label>
                            </div>
                          </div>                          
                          
                          <div class="form-group">
                            <label for="register-password">Contrase√±a</label>
                            <div class="password-container">
                              <input type="password" id="register-password" placeholder="M√≠n. 6 caracteres" required>
                              <span class="toggle-password" onclick="togglePassword('register-password', this)">üëÅÔ∏è</span>
                            </div>
                          </div>

                          <div class="form-group">
                            <button type="button" onclick="generarPasswordFuerte()" style="width: 100%; padding: 10px; background: #4a6cf7; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                              üîê Generar Contrase√±a Segura
                            </button>
                          </div>
                          
                          <div class="form-group">
                            <label for="register-confirm">Confirmar contrase√±a</label>
                            <div class="password-container">
                              <input type="password" id="register-confirm" placeholder="Confirmar contrase√±a" required>
                              <span class="toggle-password" onclick="togglePassword('register-confirm', this)">üëÅÔ∏è</span>
                            </div>
                          </div>                          
                            
                        <button type="button" onclick="registerUser()">Registrarse</button>
                        <p><a href="#" onclick="showLoginForm()">¬øYa tienes cuenta? Inicia sesi√≥n</a></p>
                    </div>
                </div>
                <div id="auth-loading" class="hidden">
                    <div class="loading-spinner"></div>
                    <p>Procesando...</p>
                </div>
            </div>
        </div>

        <!-- Aplicaci√≥n principal (oculta inicialmente) -->
        <div class="main-app hidden" id="main-app">
            <div class="header">
                <div class="header-content">
                    <div class="text-container">
                      <h1>üõ©Ô∏è Sistema Predicto FlyAware</h1>
                      <p>Sistema inteligente de predicci√≥n basado en condiciones clim√°ticas</p>
                    </div>
                  
                    <div class="profile-container">
                      <div class="user-icon" onclick="toggleUserMenu()">
                        <img id="profile-pic" src="/static/default-profile.png" alt="Perfil" />
                      </div>
                      <div id="user-menu" class="user-menu hidden">
                        <p id="user-name">Usuario</p>
                        <button onclick="logoutUser()">Cerrar Sesi√≥n</button>
                        <button onclick="window.location.href='/historial'">Historial de Predicciones</button>
                      </div>
                    </div>
                </div>                  
            </div>

            <div class="main-content">
                <div class="form-section">
                    <form id="prediction-form">
                        <div id="vuelos-container">
                            <div class="vuelo-group" data-index="0">
                                <h3>Vuelo 1</h3>
                                <div class="form-group">
                                    <label>Ciudad de Origen:</label>
                                    <select id="origen" name="origen" required>
                                      <option value="">Seleccionar ciudad...</option>
                                      <option value="lima">Lima</option>
                                      <option value="arequipa">Arequipa</option>
                                      <option value="trujillo">Trujillo</option>
                                      <option value="piura">Piura</option>
                                      <option value="cajamarca">Cajamarca</option>
                                      <option value="puno">Puno</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Ciudad de Destino:</label>
                                    <select id="ciudad" name="ciudad" required>
                                        <option value="">Seleccionar ciudad...</option>
                                        <option value="lima">Lima</option>
                                        <option value="arequipa">Arequipa</option>
                                        <option value="trujillo">Trujillo</option>
                                        <option value="piura">Piura</option>
                                        <option value="cajamarca">Cajamarca</option>
                                        <option value="puno">Puno</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Fecha del Vuelo:</label>
                                    <input type="date" id="fecha" name="fecha" required>
                                </div>
                                <div class="form-group">
                                    <label>Hora de Partida:</label>
                                    <input type="time" id="hora" name="hora_partida" required>
                                </div>
                                <div class="form-group">
                                    <label>Hora de Llegada:</label>
                                    <input type="time" id="hora_llegada" name="hora_llegada" required>
                                </div>
                                <div class="form-group">
                                    <label>N√∫mero estimado de pasajeros:</label>
                                    <input type="number" id="pasajeros" name="pasajeros" min="1" value="120" required>
                                </div>
                                <div class="form-group">
                                    <label>Costo estimado por pasajero (USD):</label>
                                    <input type="number" id="costo" name="costo" min="1" value="100" required>
                                </div>
                                <hr>
                            </div>
                        </div>
                        
                        <button type="button" class="agregar-btn" onclick="agregarVuelo()">
                            + Agregar otro vuelo
                        </button>

                        <button type="submit" class="predict-btn" id="predict-btn">
                            <span class="loading-spinner" id="loading-spinner"></span>
                            <span id="predict-btn-text">Predecir Retraso</span>
                        </button>
                    </form>
                </div>

                <div class="results-section" id="results-section">
                    <!-- Vista previa antes de predecir -->
                    <div id="placeholder-prediccion" class="placeholder-prediccion" style="
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                        height: 100%;
                    ">
                      <h2>Resultado de la Predicci√≥n</h2>
                      <div class="prediction-placeholder-content" style="text-align: center;">
                        <img src="/static/flight-predict.png"
                             alt="Esperando predicci√≥n"
                             style="
                               max-width: 350px;
                               width: 100%;
                               height: auto;
                               display: block;
                               margin: 0 auto 15px auto;
                             " />
                        <p class="placeholder-text" style="
                            font-size: 1.2em;
                            color: #555;
                            margin-top: 0;
                          ">
                          Aqu√≠ aparecer√°n los resultados una vez que realices una predicci√≥n.
                        </p>
                      </div>
                    </div>
                  
                    <div id="resultado-prediccion" style="display: none;">
                      <div class="risk-indicator" id="risk-indicator">
                        <div id="risk-text">Analizando...</div>
                      </div>

                      <!-- NUEVO: Resumen autom√°tico -->
                      <div class="prediction-summary" id="prediction-summary" style="display: none;">
                        <p class="summary-text" id="summary-text"></p>
                        <button class="explain-btn" id="explain-btn" onclick="mostrarExplicacionDetallada()">
                          üîç Ver explicaci√≥n detallada
                        </button>
                      </div>
                  
                      <div>
                        <strong>Probabilidad de Retraso:</strong>
                        <div class="probability-bar">
                          <div class="probability-fill" id="probability-fill" style="width: 0%;"></div>
                        </div>
                        <div style="text-align: center; font-weight: bold;" id="probability-text">0%</div>
                      </div>
                  
                      <div class="weather-info" id="weather-info">
                        <!-- Datos clim√°ticos -->
                      </div>
                  
                      <div class="recommendations" id="recommendations">
                        <h3>Recomendaciones</h3>
                        <ul id="recommendations-list"></ul>
                      </div>
                    </div>
                  </div>
                  
            </div>

            <div class="stats-section">
                <h2>Estad√≠sticas del Sistema</h2>
                <div class="stats-grid" id="stats-grid">
                    <div class="stat-card">
                        <div class="number" id="predicciones-hoy">-</div>
                        <div class="label">Predicciones Hoy</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="precision-modelo">-</div>
                        <div class="label">Precisi√≥n del Modelo</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="retrasos-evitados">-</div>
                        <div class="label">Retrasos Evitados</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="ahorro-estimado">-</div>
                        <div class="label">Ahorro Estimado (USD)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NUEVO: Modal de explicaci√≥n detallada -->
    <div id="explanation-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìä Explicaci√≥n Detallada de la Predicci√≥n</h2>
                <button class="close-btn" onclick="cerrarExplicacionDetallada()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="explanation-section">
                    <h3>üéØ Resultado Final</h3>
                    <div id="modal-risk-summary" class="risk-summary-modal"></div>
                </div>

                <div class="explanation-section">
                    <h3>üìà Variables Clave Analizadas</h3>
                    <div id="modal-variables" class="variables-grid"></div>
                </div>

                <div class="explanation-section">
                    <h3>üå§Ô∏è Condiciones Meteorol√≥gicas</h3>
                    <div id="modal-weather-details" class="weather-details"></div>
                </div>

                <div class="explanation-section">
                    <h3>‚ö†Ô∏è Factores de Riesgo Identificados</h3>
                    <div id="modal-risk-factors" class="risk-factors-list"></div>
                </div>

                <div class="explanation-section">
                    <h3>üí° Recomendaciones Espec√≠ficas</h3>
                    <div id="modal-recommendations" class="recommendations-detailed"></div>
                </div>

                <div class="explanation-section">
                    <h3>üîß C√≥mo funciona el modelo</h3>
                    <div class="model-explanation">
                        <p>Nuestro sistema utiliza un algoritmo de machine learning que analiza:</p>
                        <ul>
                            <li><strong>Datos hist√≥ricos de vuelos</strong> - Patrones de retrasos anteriores</li>
                            <li><strong>Condiciones meteorol√≥gicas</strong> - Temperatura, humedad, velocidad del viento</li>
                            <li><strong>Factores operacionales</strong> - Hora del d√≠a, d√≠a de la semana, temporada</li>
                            <li><strong>Capacidad del aeropuerto</strong> - Volumen de tr√°fico y congesti√≥n</li>
                        </ul>
                        <p>La predicci√≥n se basa en el an√°lisis de m√°s de 100,000 vuelos hist√≥ricos y se actualiza continuamente.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="cerrarExplicacionDetallada()">Cerrar</button>
                <button class="btn-primary" onclick="descargarReporte()">üìÑ Descargar Reporte</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/index.js') }}"></script>
    <script src="{{ url_for('static', filename='js/explicacion.js') }}"></script>
</body>
</html>